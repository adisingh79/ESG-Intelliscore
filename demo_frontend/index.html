<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>ESG Platform Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #0f172a;
            color: #e5e7eb;
        }
        header {
            padding: 1.5rem 2rem;
            background: linear-gradient(90deg, #0f172a, #0b1120);
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            margin: 0;
            font-size: 1.3rem;
        }
        header span.env {
            font-size: 0.85rem;
            padding: 0.25rem 0.6rem;
            border-radius: 999px;
            background: rgba(56, 189, 248, 0.1);
            color: #7dd3fc;
            border: 1px solid rgba(125, 211, 252, 0.4);
        }
        main {
            padding: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
        }
        .card {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 0.75rem;
            padding: 1.25rem 1.5rem;
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
        }
        .card h2 {
            margin-top: 0;
            font-size: 1rem;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            color: #9ca3af;
        }
        .card p.helper {
            margin-top: 0.1rem;
            font-size: 0.85rem;
            color: #6b7280;
        }
        label {
            display: block;
            font-size: 0.85rem;
            margin-top: 0.75rem;
            margin-bottom: 0.2rem;
            color: #e5e7eb;
        }
        input[type="file"],
        input[type="number"],
        input[type="text"] {
            width: 100%;
            padding: 0.5rem 0.6rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(15, 23, 42, 0.8);
            color: #e5e7eb;
            font-size: 0.9rem;
        }
        input[type="number"]::placeholder,
        input[type="text"]::placeholder {
            color: #6b7280;
        }
        button {
            margin-top: 0.9rem;
            padding: 0.55rem 0.9rem;
            border-radius: 999px;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            background: linear-gradient(135deg, #0ea5e9, #6366f1);
            color: #f9fafb;
            box-shadow: 0 14px 35px rgba(37, 99, 235, 0.45);
            transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.08s ease;
        }
        button:hover {
            transform: translateY(-1px);
            filter: brightness(1.05);
            box-shadow: 0 18px 45px rgba(37, 99, 235, 0.6);
        }
        button.secondary {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.4);
            box-shadow: none;
        }
        pre {
            margin-top: 0.8rem;
            font-size: 0.8rem;
            padding: 0.75rem;
            background: rgba(15, 23, 42, 0.95);
            border-radius: 0.6rem;
            max-height: 260px;
            overflow: auto;
            border: 1px solid rgba(31, 41, 55, 0.9);
        }
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.45);
            color: #9ca3af;
        }
        .layout-row {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }
        .layout-row > div {
            flex: 1;
        }
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>ESG IntelliScore â€“ Demo Console</h1>
            <p style="margin: 0; font-size: 0.85rem; color: #9ca3af;">
                Temporary frontend for interacting with the Django ESG backend APIs.
            </p>
        </div>
        <span class="env">Backend: http://localhost:8000/api/</span>
    </header>

    <!-- The csrf_token tag ensures the cookie is set -->
    <form style="display:none;">{% csrf_token %}</form>

    <main>
        <!-- Upload ZIP -->
        <section class="card">
            <h2>Upload ESG ZIP</h2>
            <p class="helper">Send a ZIP file to <code>/api/upload-zip/</code> and see the ingestion summary.</p>
            <form id="upload-form">
                <label for="zip-file">ZIP file</label>
                <input id="zip-file" type="file" name="file" accept=".zip" required />
                <button type="submit">Upload &amp; Ingest</button>
            </form>
            <pre id="upload-result">{ "status": "awaiting upload" }</pre>
        </section>

        <!-- Companies -->
        <section class="card">
            <h2>Companies ESG Scores</h2>
            <p class="helper">Fetch all companies from <code>/api/companies/</code>.</p>
            <button class="secondary" type="button" onclick="fetchCompanies()">Load companies</button>
            <pre id="companies-result">[]</pre>
        </section>

        <!-- Company Details & Report -->
        <section class="card">
            <h2>Company Details &amp; Report</h2>
            <p class="helper">Use the latest data from <code>/api/companies/&lt;id&gt;/</code> and <code>/api/reports/&lt;company&gt;/</code>.</p>
            <div class="layout-row">
                <div>
                    <label for="company-id">Company ESG (by ID)</label>
                    <input id="company-id" type="number" min="1" placeholder="e.g. 1" />
                    <button class="secondary" type="button" onclick="fetchCompanyDetail()">Get ESG details</button>
                </div>
                <div>
                    <label for="company-name">Company report (by name)</label>
                    <input id="company-name" type="text" placeholder="e.g. TCS" />
                    <button class="secondary" type="button" onclick="fetchCompanyReport()">Get report</button>
                </div>
            </div>
            <pre id="company-detail-result">{}</pre>
            <pre id="company-report-result">{}</pre>
        </section>

        <!-- News -->
        <section class="card">
            <h2>News Sentiment</h2>
            <p class="helper">Fetch all ESG news from <code>/api/news/</code>.</p>
            <button class="secondary" type="button" onclick="fetchNews()">Load news</button>
            <pre id="news-result">[]</pre>
        </section>

        <!-- Prediction -->
        <section class="card">
            <h2>ESG Prediction</h2>
            <p class="helper">
                Call <code>/api/predict/</code> with the same features used by the model.
            </p>
            <form id="predict-form">
                <label for="sentiment-score">Sentiment score</label>
                <input id="sentiment-score" type="number" step="0.01" value="0.2" />

                <label for="env-score">Environmental score</label>
                <input id="env-score" type="number" step="0.1" value="55" />

                <label for="soc-score">Social score</label>
                <input id="soc-score" type="number" step="0.1" value="60" />

                <label for="gov-score">Governance score</label>
                <input id="gov-score" type="number" step="0.1" value="50" />

                <button type="submit">Predict ESG score</button>
            </form>
            <pre id="predict-result">{ "predicted_esg_score": null }</pre>
        </section>
    </main>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === name + "=") {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie("csrftoken");

        function safeStringify(data) {
            try {
                return JSON.stringify(data, null, 2);
            } catch (e) {
                return String(data);
            }
        }

        // Upload ZIP
        document.getElementById("upload-form").addEventListener("submit", async function (event) {
            event.preventDefault();
            const fileInput = document.getElementById("zip-file");
            const resultEl = document.getElementById("upload-result");

            if (!fileInput.files.length) {
                resultEl.textContent = '{"error": "Please choose a ZIP file first."}';
                return;
            }

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            resultEl.textContent = "Uploading...";

            try {
                const response = await fetch("/api/upload-zip/", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": csrftoken || "",
                    },
                    body: formData,
                    credentials: "include",
                });
                const data = await response.json();
                resultEl.textContent = safeStringify(data);
            } catch (error) {
                resultEl.textContent = safeStringify({ error: String(error) });
            }
        });

        // Companies
        async function fetchCompanies() {
            const resultEl = document.getElementById("companies-result");
            resultEl.textContent = "Loading...";
            try {
                const response = await fetch("/api/companies/");
                const data = await response.json();
                resultEl.textContent = safeStringify(data);
            } catch (error) {
                resultEl.textContent = safeStringify({ error: String(error) });
            }
        }

        // Company detail
        async function fetchCompanyDetail() {
            const id = document.getElementById("company-id").value;
            const resultEl = document.getElementById("company-detail-result");
            if (!id) {
                resultEl.textContent = '{"error": "Enter a company ID."}';
                return;
            }
            resultEl.textContent = "Loading...";
            try {
                const response = await fetch(`/api/companies/${encodeURIComponent(id)}/`);
                const data = await response.json();
                resultEl.textContent = safeStringify(data);
            } catch (error) {
                resultEl.textContent = safeStringify({ error: String(error) });
            }
        }

        // Company report
        async function fetchCompanyReport() {
            const name = document.getElementById("company-name").value.trim();
            const resultEl = document.getElementById("company-report-result");
            if (!name) {
                resultEl.textContent = '{"error": "Enter a company name."}';
                return;
            }
            resultEl.textContent = "Loading...";
            try {
                const response = await fetch(`/api/reports/${encodeURIComponent(name)}/`);
                const data = await response.json();
                resultEl.textContent = safeStringify(data);
            } catch (error) {
                resultEl.textContent = safeStringify({ error: String(error) });
            }
        }

        // News
        async function fetchNews() {
            const resultEl = document.getElementById("news-result");
            resultEl.textContent = "Loading...";
            try {
                const response = await fetch("/api/news/");
                const data = await response.json();
                resultEl.textContent = safeStringify(data);
            } catch (error) {
                resultEl.textContent = safeStringify({ error: String(error) });
            }
        }

        // Predict
        document.getElementById("predict-form").addEventListener("submit", async function (event) {
            event.preventDefault();
            const resultEl = document.getElementById("predict-result");

            const payload = {
                sentiment_score: parseFloat(document.getElementById("sentiment-score").value),
                environmental_score: parseFloat(document.getElementById("env-score").value),
                social_score: parseFloat(document.getElementById("soc-score").value),
                governance_score: parseFloat(document.getElementById("gov-score").value),
            };

            resultEl.textContent = "Predicting...";

            try {
                const response = await fetch("/api/predict/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken || "",
                    },
                    credentials: "include",
                    body: JSON.stringify(payload),
                });
                const data = await response.json();
                resultEl.textContent = safeStringify(data);
            } catch (error) {
                resultEl.textContent = safeStringify({ error: String(error) });
            }
        });
    </script>
</body>
</html>

